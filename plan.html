<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DSE æ™ºèƒ½ä¸€é€±å­¸ç¿’è¨ˆåŠƒ</title>

<style>
:root{
  --primary:#0052cc;
  --accent:#4caf50;
  --bg:#f4f7ff;
  --panel:#fff;
  --text:#222;
}
@media (prefers-color-scheme: dark){
  :root{
    --primary:#4a90e2;
    --accent:#00cc66;
    --bg:#1e1e1e;
    --panel:#2a2a2a;
    --text:#eee;
  }
}
body{font-family:"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text);margin:0;}
header{background:var(--primary);color:#fff;text-align:center;padding:1rem;}
main{max-width:850px;margin:1rem auto;background:var(--panel);border-radius:12px;padding:1rem;box-shadow:0 0 6px rgba(0,0,0,.15);}
button{border:none;border-radius:6px;padding:0.5rem 1rem;margin:0.2rem;cursor:pointer;color:#fff;}
button.back{background:#666;}
button.back:hover{background:#777;}
button.setting{background:#f39c12;}
button.export{background:var(--accent);}
h2{border-left:6px solid var(--primary);padding-left:0.4rem;}
#suggestion,#weekPlan{background:#e8f0ff;border-radius:8px;padding:0.8rem;margin:0.6rem 0;}
#pieChart{width:100%;height:280px;}
table{width:100%;border-collapse:collapse;margin-top:0.5rem;}
th,td{border:1px solid #ccc;text-align:center;padding:0.4rem;}
th{background:var(--primary);color:#fff;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:0.6rem 1rem;border-radius:6px;opacity:0;transition:opacity .4s;}
.toast.show{opacity:1;}
#settingsModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:var(--panel);border-radius:8px;padding:1rem;width:90%;max-width:400px;}
.modal-content input{width:100%;padding:0.4rem;margin-bottom:0.4rem;}
.modal-buttons{text-align:center;margin-top:0.6rem;}
footer{text-align:center;color:#888;font-size:0.8rem;margin:1rem 0;}
</style>
</head>

<body>
<header>
  <h1>ğŸ“Š DSE æ™ºèƒ½ä¸€é€±å­¸ç¿’è¨ˆåŠƒ</h1>
  <div id="date"></div>
  <div id="clock"></div>
</header>

<main>
  <div style="text-align:center;">
    <button class="back" onclick="window.location.href='index.html'">ğŸ”™ è¿”å›æ‰“å¡é </button>
    <button class="setting" id="openSetting">âš™ï¸ å€‹äººè¨­å®š</button>
  </div>

  <h2>ğŸ§  ä»Šæ—¥å»ºè­°ç§‘ç›®</h2>
  <div id="suggestion">è¼‰å…¥ä¸­...</div>

  <h2>ğŸ“Š å„ç§‘æº«ç¿’æ¯”ä¾‹</h2>
  <canvas id="pieChart"></canvas>

  <h2>ğŸ“… ä¸€é€±æ™ºèƒ½è¨ˆåŠƒ</h2>
  <div id="weekPlan">è¼‰å…¥ä¸­...</div>
</main>

<footer>Â© 2025â€“2026 DSE Smart Study Tracker</footer>
<div class="toast" id="toast">âœ… å·²å„²å­˜ï¼</div>

<!-- è¨­å®šModal -->
<div id="settingsModal">
  <div class="modal-content">
    <h3>è¨­å®šé æœŸåˆ†æ•¸ï¼ˆ1=å¼±ç§‘ï¼Œ5=å¼·ç§‘ï¼‰</h3>
    ä¸­æ–‡ï¼š<input type="number" id="score_chi" min="1" max="5">
    è‹±æ–‡ï¼š<input type="number" id="score_eng" min="1" max="5">
    æ•¸å­¸ï¼š<input type="number" id="score_math" min="1" max="5">
    åŒ–å­¸ï¼š<input type="number" id="score_chem" min="1" max="5">
    ICTï¼š<input type="number" id="score_ict" min="1" max="5">
    <div class="modal-buttons">
      <button class="export" id="saveSetting">ğŸ’¾ å„²å­˜è¨­å®š</button>
      <button class="setting" id="closeSetting">é—œé–‰</button>
    </div>
  </div>
</div>

<script>
// ğŸ•’ æ™‚é˜ & æ—¥æœŸ
function updateClock(){
  const d=new Date();
  document.getElementById("clock").innerText=d.toLocaleTimeString("zh-HK",{hour12:false});
}
setInterval(updateClock,1000);updateClock();
const d=new Date();
const weekDay="æ—¥ä¸€äºŒä¸‰å››äº”å…­"[d.getDay()];
document.getElementById("date").innerText=
  `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ï¼ˆæ˜ŸæœŸ${weekDay}ï¼‰`;

function toast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1800);
}

// è®€å–è¨­å®š
function getScores(){
  let s=JSON.parse(localStorage.getItem("dseScores")||"{}");
  return {chi:+(s.chi||3),eng:+(s.eng||3),math:+(s.math||3),chem:+(s.chem||3),ict:+(s.ict||3)};
}
function saveScores(o){localStorage.setItem("dseScores",JSON.stringify(o));}

// Modal
const modal=document.getElementById("settingsModal");
document.getElementById("openSetting").onclick=()=>{
  modal.style.display="flex";
  const s=getScores();
  ["chi","eng","math","chem","ict"].forEach(k=>{
    document.getElementById("score_"+k).value=s[k];
  });
};
document.getElementById("closeSetting").onclick=()=>modal.style.display="none";
document.getElementById("saveSetting").onclick=()=>{
  const o={
    chi:document.getElementById("score_chi").value,
    eng:document.getElementById("score_eng").value,
    math:document.getElementById("score_math").value,
    chem:document.getElementById("score_chem").value,
    ict:document.getElementById("score_ict").value
  };
  saveScores(o);modal.style.display="none";toast("âœ… å·²æ›´æ–°è¨­å®šï¼");
  setTimeout(()=>location.reload(),1000);
};

// ğŸ“… æ’ç¨‹é‚è¼¯
function generateWeightedWeek(){
  const s=getScores();
  const keys=["chi","eng","math","chem","ict"];
  const names=["ä¸­æ–‡","è‹±æ–‡","æ•¸å­¸","åŒ–å­¸","ICT"];
  let total=0,weights={};
  names.forEach((n,i)=>{weights[n]=6-s[keys[i]];total+=weights[n];});
  const perc={},planDays=[];
  names.forEach(n=>{perc[n]=Math.round(weights[n]/total*100);});
  names.forEach(n=>{
    let d=Math.round(weights[n]/total*7); if(d<1)d=1;
    planDays.push({subject:n,days:d});
  });
  let sum=planDays.reduce((a,b)=>a+b.days,0);
  while(sum>7){planDays.sort((a,b)=>b.days-a.days)[0].days--;sum--;}

  const schedule={},used={};names.forEach(n=>used[n]=0);
  for(let i=0;i<7;i++){
    const pick=planDays.sort((a,b)=>(b.days-used[b.subject])-(a.days-used[a.subject]))[0];
    used[pick.subject]++;

    // â­ï¸ æ–°å‰¯ç§‘é‚è¼¯ï¼šå¾å…¶ä»–ç§‘éš¨æ©Ÿé¸ä¸€å€‹
    const remain=planDays.filter(p=>p.subject!==pick.subject);
    const subPick=remain[Math.floor(Math.random()*remain.length)].subject;
    schedule[i]={main:pick.subject,sub:subPick};
  }
  return {schedule,perc};
}

// ç”¢ç”Ÿè¡¨æ ¼ + ä»Šæ—¥å»ºè­°
const {schedule,perc}=generateWeightedWeek();
const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
let html="<table><tr><th>æ˜ŸæœŸ</th><th>ä¸»ç§‘</th><th>å‰¯ç§‘</th></tr>";
for(let i=0;i<7;i++){
  html+=`<tr><td>æ˜ŸæœŸ${days[i]}</td><td>${schedule[i].main}</td><td>${schedule[i].sub}</td></tr>`;
}
html+="</table>";
document.getElementById("weekPlan").innerHTML=html;

const todayPlan=schedule[d.getDay()];
document.getElementById("suggestion").innerHTML=
  `ğŸ’¡ <b>ä¸»ç§‘ï¼š</b>${todayPlan.main}<br>ğŸ§© <b>å‰¯ç§‘ï¼š</b>${todayPlan.sub}`;

// ğŸ§© åŒæ­¥åˆ° index.html
localStorage.setItem('todaySuggestion', JSON.stringify(todayPlan));

// ğŸ“Š åœ“é¤…åœ–ç¹ªè£½
const colors=["#ff6384","#36a2eb","#ffcd56","#4bc0c0","#9966ff"];
function drawPie(data){
  const c=document.getElementById("pieChart");const ctx=c.getContext("2d");
  const total=Object.values(data).reduce((a,b)=>a+b,0);
  const cx=c.width/2,cy=c.height/2,r=Math.min(cx,cy)-10;
  let start=0,i=0;ctx.clearRect(0,0,c.width,c.height);
  for(const k in data){
    const slice=2*Math.PI*data[k]/total;
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+slice);ctx.closePath();
    ctx.fillStyle=colors[i%colors.length];ctx.fill();start+=slice;i++;
  }
  let y=20,j=0;
  for(const k in data){
    ctx.fillStyle=colors[j%colors.length];
    ctx.fillRect(c.width-120,y-10,14,14);
    ctx.fillStyle=(window.matchMedia('(prefers-color-scheme:dark)').matches?"#fff":"#000");
    ctx.font="13px sans-serif";ctx.fillText(`${k} ${data[k]}%`,c.width-100,y+3);
    y+=22;j++;
  }
}
function resize(){const c=document.getElementById("pieChart");c.width=c.clientWidth;c.height=280;drawPie(perc);}
window.addEventListener('resize',resize);resize();
</script>
</body>
</html>
