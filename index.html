<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DSEæ¯æ—¥å­¸ç¿’æ‰“å¡</title>

<style>
:root {
  --primary: #0052cc;
  --bg: #f4f7ff;
  --text: #222;
  --panel: #fff;
  --accent: #4caf50;
}
@media (prefers-color-scheme: dark) {
  :root {
    --primary: #4a90e2;
    --bg: #1e1e1e;
    --text: #f0f0f0;
    --panel: #2a2a2a;
    --accent: #00cc66;
  }
}
body {
  font-family: "Noto Sans TC", sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
}
header {
  background: var(--primary);
  color: white;
  text-align: center;
  padding: 1rem;
}
#clock { font-size: 1.2rem; margin-top: 0.3rem; font-weight: bold; }
main {
  background: var(--panel);
  max-width: 750px;
  margin: 1rem auto;
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 0 8px rgba(0,0,0,0.15);
}
h2 {
  border-left: 6px solid var(--primary);
  padding-left: 0.4rem;
  font-size: 1rem;
}
#suggestion {
  background: #e8f0ff;
  padding: 0.8rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.5rem;
}
th, td {
  border: 1px solid #ccc;
  padding: 0.5rem;
  text-align: center;
}
th { background: var(--primary); color: white; }
td.school { background: #f0f0f0; color: #777; }
.subject-input {
  width: 100%; border: none; border-bottom: 1px solid #ccc;
  background: transparent; text-align: center; font-size: 0.9rem; color: var(--text);
}
input[type=checkbox]{ transform: scale(1.3); }
.buttons { text-align: center; margin: 1rem 0; }
button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 0.6rem 1rem;
  margin: 0.3rem;
  font-size: 0.9rem;
  cursor: pointer;
}
button.clear { background:#666; }
button.export { background: var(--accent); }

.progress-bar {
  width:100%;
  background:#ddd;
  height:16px;
  border-radius:8px;
  overflow:hidden;
}
.progress-fill {
  height:100%; width:0;
  background:var(--accent);
  transition: width 0.4s ease, background 0.4s ease;
}
.progress-label { text-align:right; font-size:0.85rem; margin-top:0.3rem; }

.toast {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:var(--primary);
  color:white;
  padding:0.6rem 1rem;
  border-radius:6px;
  opacity:0;
  transition:opacity 0.5s;
  z-index:999;
}
.toast.show {opacity:1;}

footer {
  text-align:center;
  font-size:0.8rem;
  color:#888;
  margin:1rem 0;
}
@media(max-width:600px){
 table,th,td{font-size:0.8rem;}
 h1{font-size:1.1rem;}
}
</style>
</head>

<body>
<header>
  <h1>ğŸ“š DSE å­¸ç¿’æ‰“å¡ç³»çµ±</h1>
  <div id="date"></div>
  <div id="clock">--:--:--</div>
</header>

<main>
  <h2>ğŸ§  ä»Šæ—¥å»ºè­°ç§‘ç›®</h2>
  <div id="suggestion">è¼‰å…¥ä¸­...</div>

  <h2>ğŸ—“ï¸ ä»Šæ—¥æ‰“å¡</h2>
  <table><thead>
    <tr><th>æ™‚é–“</th><th>å…§å®¹</th><th>å®Œæˆ</th></tr>
  </thead><tbody id="scheduleBody"></tbody></table>

  <div class="buttons">
    <button id="save">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
    <button id="clear" class="clear">ğŸ§¹ æ¸…é™¤</button>
    <button id="export" class="export">ğŸ“¤ åŒ¯å‡ºæœ¬é€±å ±å‘Š</button>
  </div>

  <h2>ğŸ“Š æœ¬é€±å®Œæˆç‡</h2>
  <div class="progress-bar"><div class="progress-fill" id="pfill"></div></div>
  <div class="progress-label" id="plabel">0%</div>
</main>

<footer>Â© 2025 DSE Study Tracker</footer>
<div class="toast" id="toast">âœ… å·²å„²å­˜ï¼</div>

<script>
// ğŸ•’ æ™‚é˜
function updateClock(){
  const n=new Date();
  document.getElementById("clock").innerText=
    n.toLocaleTimeString("zh-HK",{hour12:false});
}
setInterval(updateClock,1000); updateClock();

// ğŸ“… æ—¥æœŸé¡¯ç¤º
const today=new Date();
const week="æ—¥ä¸€äºŒä¸‰å››äº”å…­"[today.getDay()];
document.getElementById("date").innerText=
  `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ï¼ˆæ˜ŸæœŸ${week}ï¼‰`;

// âœ”ï¸ keyPrefix
const keyPrefix=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

// ğŸ¯ å»ºè­°ç§‘ç›®
const plan={
  1:{main:"ä¸­æ–‡",sub:"è‹±æ–‡"},2:{main:"æ•¸å­¸",sub:"åŒ–å­¸"},
  3:{main:"ICT",sub:"è‹±æ–‡"},4:{main:"æ•¸å­¸",sub:"ä¸­æ–‡"},
  5:{main:"åŒ–å­¸",sub:"ICT"},6:{main:"Past Paper æ¨¡æ“¬",sub:"å¼±ç§‘é‡é»"},
  0:{main:"è‡ªç”±æº«ç¿’ï¼ä¼‘æ¯",sub:"éŒ¯é¡Œæ•´ç†"}
};
const tp=plan[today.getDay()];
document.getElementById("suggestion").innerHTML=
  `ğŸ’¡ <b>ä¸»ç§‘ï¼š</b>${tp.main}<br>ğŸ§© <b>å‰¯ç§‘ï¼š</b>${tp.sub}`;

// â° æ™‚æ®µ
const tbody=document.getElementById("scheduleBody");
let schedule=[];
if(today.getDay()>=1&&today.getDay()<=5){
  schedule=[
    {time:"08:00â€“16:30",school:true,label:"å­¸æ ¡ä¸Šèª²æ™‚é–“"},
    {time:"17:00â€“18:00"},
    {time:"18:00â€“19:30"},
    {time:"19:30â€“21:00"},
    {time:"21:00â€“22:30"}];
}else{
  schedule=[
    {time:"09:00â€“10:30"},{time:"10:30â€“12:00"},
    {time:"13:00â€“14:30"},{time:"14:30â€“16:00"},
    {time:"16:00â€“17:30"},{time:"19:00â€“20:30"},
    {time:"20:30â€“22:00"}];
}

schedule.forEach((s,i)=>{
  const tr=document.createElement("tr");
  if(s.school){
    tr.innerHTML=`<td>${s.time}</td><td class="school">${s.label}</td><td>ğŸ«</td>`;
  }else{
    tr.innerHTML=`
      <td>${s.time}</td>
      <td><input id="s${i}" class="subject-input" placeholder="å­¸ç¿’å…§å®¹"></td>
      <td><input type="checkbox" id="c${i}"></td>`;
  }
  tbody.appendChild(tr);
});
const ids=schedule.filter(s=>!s.school)
  .flatMap((_,i)=>["s"+i,"c"+i]);

function toast(msg){
  const el=document.getElementById("toast");
  el.innerText=msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),2000);
}

// ğŸ§© å„²å­˜ + è¼‰å…¥
function saveData(){
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el) localStorage.setItem(keyPrefix+"_"+id, el.type==="checkbox"?el.checked:el.value);
  });
  toast("âœ… ä»Šæ—¥ç´€éŒ„å·²å„²å­˜ï¼");
  updateProgress();
}
function loadData(){
  ids.forEach(id=>{
    const el=document.getElementById(id);
    const val=localStorage.getItem(keyPrefix+"_"+id);
    if(val!==null){
      if(el.type==="checkbox") el.checked=(val==="true");
      else el.value=val;
    }
  });
}
function clearData(){
  if(confirm("ç¢ºå®šè¦æ¸…é™¤ä»Šæ—¥ç´€éŒ„ï¼Ÿ")){
    ids.forEach(id=>localStorage.removeItem(keyPrefix+"_"+id));
    location.reload();
  }
}
document.getElementById("save").onclick=saveData;
document.getElementById("clear").onclick=clearData;
loadData();

// ğŸ“Š é€²åº¦æ¢ï¼ˆä¿®æ­£ç‰ˆï¼‰
function updateProgress(){
  const now = new Date();
  let total = 0, done = 0;

  // é‡æ–°ç”Ÿæˆå›ºå®šçš„7å¤©æ—¥æœŸç¯„åœï¼ˆä¸ä¾ schedule æœ¬èº«ï¼‰
  for (let i = 0; i < 7; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

    // å˜—è©¦æœ€å¤š 10 å€‹æ™‚æ®µï¼ˆé¿å…ä¸åŒæ—¥å­ schedule é•·åº¦ä¸åŒæ™‚å‡ºéŒ¯ï¼‰
    for (let idx = 0; idx < 10; idx++) {
      const doneKey = localStorage.getItem(dateKey + "_c" + idx);
      if (doneKey !== null) {
        total++;
        if (doneKey === "true") done++;
      }
    }
  }

  const per = total ? Math.round(done / total * 100) : 0;
  const fill = document.getElementById("pfill");
  const lbl = document.getElementById("plabel");

  if (fill && lbl) {
    fill.style.width = per + "%";
    fill.style.minWidth = "4px";   // å³ä½¿ 0% æ™‚ä»å¯è¦‹
    fill.style.background = 
      per < 50 ? "#ff4d4d" :
      per < 80 ? "#ffc107" :
      "var(--accent)";
    lbl.innerText = per + "%";
  }
}
document.querySelectorAll("input[type='checkbox']").forEach(c=>c.onchange=updateProgress);
window.addEventListener('DOMContentLoaded', updateProgress);

// ğŸ“¤ åŒ¯å‡º CSV
document.getElementById("export").addEventListener("click",()=>{
  let csv="æ—¥æœŸ,æ™‚é–“,å­¸ç¿’å…§å®¹,å®Œæˆ\n";
  for(let i=0;i<7;i++){
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    for(let idx=0;idx<10;idx++){
      const subject=localStorage.getItem(k+"_s"+idx)||"";
      const done=localStorage.getItem(k+"_c"+idx)==="true"?"âœ”":"";
      if(subject || done) csv+=`${k},æ™‚æ®µ${idx+1},${subject},${done}\n`;
    }
  }
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="DSE-Week-Report.csv";
  link.click();
  toast("ğŸ“¤ å·²åŒ¯å‡ºæœ¬é€±å ±å‘Šï¼");
});
</script>
</body>
</html>
